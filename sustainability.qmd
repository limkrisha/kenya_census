---
title: "Kenya Census"
format:
  html:
    theme: cosmo
    page-layout: full
    toc: false
    css: styles.css
editor: visual
---

```{r background, echo = F}
pacman::p_load(dplyr, here, tidyverse, readr, readxl, janitor, gtsummary, lubridate, gtsummary)
source(here("code", "1_setup.R"))


```

## Sustainability

Questions about sustainability projects are only asked for those who have children attending primary school.

```{r, echo = F}

# Select one table first
sust_single_vars_1 <- c(
  "edu_primary_school_any",
  "sust_project_any"
)

tbl_sust_single <- make_tbl_by_comm(clean, sust_single_vars_1)
tbl_sust_single   %>% 
  as_gt() %>%
  opt_row_striping()
```

## Ongoing sustainability projects

```{r ongoing, echo = F}

# select multiple table
tbl_sust_projects <- make_multi_tbl_by_comm(clean, "sust_project_list")
tbl_sust_projects %>% 
  as_gt() %>%
  opt_row_striping()


```

### Other ongoing sustainability projects

```{r ongoing_other, echo = F}
sust_other_by_comm <- other_tables_long[["sust_project_list"]] %>%
  filter(!is.na(other_text), other_text != "") %>%
  mutate(other_group = standardize_sust_other(other_text)) %>%
  group_by(geo_community, other_group) %>%
  summarise(Count = dplyr::n(), .groups = "drop") %>%
  arrange(desc(Count))

sust_other_by_comm %>%
  arrange(geo_community) %>%
  rename(Community = geo_community, `Other (grouped)` = other_group) %>%
  gt() %>%
  tab_header(title = "Other sustainability projects mentioned (by community)") %>%
  fmt_number(columns = Count, decimals = 0) %>%
  opt_row_striping() %>%
  tab_style(
  style = cell_borders(
    sides = "bottom",
    color = "#d1d5db",
    weight = px(2)
  ),
  locations = cells_body(
    rows = Community != dplyr::lead(Community)
  ))

```

## Parent involvement and Income-generating activities

```{r sust2, echo = F}

# Select one table first
sust_single_vars_2 <- c(
  "sust_parent_involvement",
  "sust_school_iga_any"
)

tbl_sust_single_2 <- make_tbl_by_comm(clean, sust_single_vars_2)
tbl_sust_single_2   %>% 
  as_gt() %>%
  opt_row_striping()
```

### List of Income-generating activities

This question is only asked for those who said 'Yes' to "Are there any income-generating activities linked to your local school?"

```{r, echo = F}
# select multiple - IGA
tbl_sust_iga <- make_multi_tbl_by_comm(clean, "sust_school_iga_list")
tbl_sust_iga

# other_tables[["sust_school_iga_list"]] %>%
#   filter(!is.na(other_text), other_text != "")

iga_other_by_comm <- other_tables_long[["sust_school_iga_list"]] %>%
  dplyr::mutate(other_group = standardize_sust_other(other_text)) %>%
  dplyr::group_by(geo_community, other_group) %>%
  dplyr::summarise(Count = dplyr::n(), .groups = "drop") %>%
  dplyr::arrange(dplyr::desc(Count))

iga_other_by_comm %>%
  arrange(geo_community) %>%
  dplyr::rename(Community = geo_community, `Other (grouped)` = other_group) %>%
  gt::gt() %>%
  gt::tab_header(title = "Other sustainability projects mentioned (by community)") %>%
  gt::fmt_number(columns = Count, decimals = 0) %>%
  opt_row_striping() %>%
  tab_style(
  style = cell_borders(
    sides = "bottom",
    color = "#d1d5db",
    weight = px(2)
  ),
  locations = cells_body(
    rows = Community != dplyr::lead(Community)
  ))
```

Note: One enumerator clicked "Farming" and "Other" but left a blank on the specify field, so that's why there's 7 "Other" but only 6 actual specified responses.

## School Facilities

```{r sust3, echo = F}

# Select one table first
sust_single_vars_3 <- c(
  "sust_school_facility_maint"
)

tbl_sust_single3 <- make_tbl_by_comm(clean, sust_single_vars_3)
tbl_sust_single3   %>% 
  as_gt() %>%
  opt_row_striping()
```

## Support needed

This question tabulates responses to, "What kind of support does your school or community need to sustain development projects?" (Select all that apply).

```{r, echo = F}
iga_support_by_comm <- other_tables_long[["sust_support_need"]] %>%
  filter(!is.na(other_text), other_text != "") %>%
  mutate(other_group = standardize_sust_other(other_text)) %>%
  group_by(geo_community, other_group) %>%
  summarise(Count = dplyr::n(), .groups = "drop") %>%
  arrange(desc(Count))

iga_support_by_comm %>%
  arrange(geo_community) %>%
  rename(
    Community = geo_community,
    `Other (grouped)` = other_group
  ) %>%
  gt() %>%
  tab_header(title = "Sustainability support needed (by community)") %>%
  fmt_number(columns = Count, decimals = 0) %>%
    opt_row_striping() %>%
  tab_style(
  style = cell_borders(
    sides = "bottom",
    color = "#d1d5db",
    weight = px(2)
  ),
  locations = cells_body(
    rows = Community != dplyr::lead(Community)
  ))
```
